<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.js 笔记 | Mirror Night&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css">
    <script charset="utf-8" src="/js/custom.js"></script>
    <meta name="description" content=" ">
    <meta name="keywords" content="Mirror Night,vuepress,自建博客,编程">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="robots" content="all">
    <meta name="author" content="Mirror Night">
    
    <link rel="preload" href="/assets/css/0.styles.e6fe5a67.css" as="style"><link rel="preload" href="/assets/js/app.d527f978.js" as="script"><link rel="preload" href="/assets/js/4.59a1108c.js" as="script"><link rel="preload" href="/assets/js/1.2bab5923.js" as="script"><link rel="preload" href="/assets/js/32.c7f6cae2.js" as="script"><link rel="preload" href="/assets/js/12.216bf9d4.js" as="script"><link rel="prefetch" href="/assets/js/10.b5b4f9b8.js"><link rel="prefetch" href="/assets/js/11.347056f1.js"><link rel="prefetch" href="/assets/js/13.337b2ac4.js"><link rel="prefetch" href="/assets/js/14.f5eb041c.js"><link rel="prefetch" href="/assets/js/15.3caeae2c.js"><link rel="prefetch" href="/assets/js/16.7746776a.js"><link rel="prefetch" href="/assets/js/17.dc74052d.js"><link rel="prefetch" href="/assets/js/18.8913bf2d.js"><link rel="prefetch" href="/assets/js/19.0e24b58d.js"><link rel="prefetch" href="/assets/js/20.50674ca0.js"><link rel="prefetch" href="/assets/js/21.80606f98.js"><link rel="prefetch" href="/assets/js/22.5ed6aa22.js"><link rel="prefetch" href="/assets/js/23.c2cd8dfe.js"><link rel="prefetch" href="/assets/js/24.661651b5.js"><link rel="prefetch" href="/assets/js/25.c607de16.js"><link rel="prefetch" href="/assets/js/26.29863ed5.js"><link rel="prefetch" href="/assets/js/27.992088e0.js"><link rel="prefetch" href="/assets/js/28.1493512b.js"><link rel="prefetch" href="/assets/js/29.2b1261ca.js"><link rel="prefetch" href="/assets/js/30.99d5cd24.js"><link rel="prefetch" href="/assets/js/31.62ab0a67.js"><link rel="prefetch" href="/assets/js/33.43d4f034.js"><link rel="prefetch" href="/assets/js/34.339a5015.js"><link rel="prefetch" href="/assets/js/35.b5db4fd0.js"><link rel="prefetch" href="/assets/js/36.a8651903.js"><link rel="prefetch" href="/assets/js/37.ff3260c6.js"><link rel="prefetch" href="/assets/js/5.246df733.js"><link rel="prefetch" href="/assets/js/6.3d649493.js"><link rel="prefetch" href="/assets/js/7.b159e648.js"><link rel="prefetch" href="/assets/js/8.155b6152.js"><link rel="prefetch" href="/assets/js/9.0c53848f.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.b4aee4ac.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e6fe5a67.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-4698c43e><div data-v-4698c43e><div id="loader-wrapper" class="loading-wrapper" data-v-1c4f0192 data-v-4698c43e data-v-4698c43e><div class="loader-main" data-v-1c4f0192><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-6cbeab0a data-v-4698c43e data-v-4698c43e><h3 class="title" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a>Mirror Night's Blog</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><input type="password" value="" data-v-6cbeab0a> <span data-v-6cbeab0a>Konck! Knock!</span> <button data-v-6cbeab0a>OK</button></label> <div class="footer" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><span data-v-6cbeab0a><i class="iconfont reco-theme" data-v-6cbeab0a></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cbeab0a>vuePress-theme-reco</a></span> <span data-v-6cbeab0a><i class="iconfont reco-copyright" data-v-6cbeab0a></i> <a data-v-6cbeab0a><span data-v-6cbeab0a>Mirror Night</span>
            
          <span data-v-6cbeab0a>2021 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-4698c43e><header class="navbar" data-v-4698c43e><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mirror Night's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      文档资料
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://developer.mozilla.org/zh-CN/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  MDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://nodejs.cn/api/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Node.js 文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://vuejs.bootcss.com/guide/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Vue中文文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://docs.ycsnews.com/docs/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  前端开发文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-4698c43e></div> <aside class="sidebar" data-v-4698c43e><div class="personal-info-wrapper" data-v-6c8ffc9c><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-6c8ffc9c> <h3 class="name" data-v-6c8ffc9c>
    Mirror Night
  </h3> <div class="num" data-v-6c8ffc9c><div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>24</h3> <h6 data-v-6c8ffc9c>文章</h6></div> <div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>21</h3> <h6 data-v-6c8ffc9c>标签</h6></div></div> <hr data-v-6c8ffc9c></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      文档资料
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://developer.mozilla.org/zh-CN/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  MDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://nodejs.cn/api/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Node.js 文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://vuejs.bootcss.com/guide/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Vue中文文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://docs.ycsnews.com/docs/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  前端开发文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Nodejs</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/技术文章/Nodejs/Nodejs.html" class="active sidebar-link">Node.js 笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#fs-文件读写" class="sidebar-link">fs 文件读写</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#path-路径模块" class="sidebar-link">path 路径模块</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#http-模块" class="sidebar-link">http 模块</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#模块化" class="sidebar-link">模块化</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#npm" class="sidebar-link">npm</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#模块加载" class="sidebar-link">模块加载</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#express" class="sidebar-link">Express</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#数据库与身份认证" class="sidebar-link">数据库与身份认证</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#node-js-操作-mysql" class="sidebar-link">Node.js 操作 MySql</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#异步" class="sidebar-link">异步</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#前后端身份认证" class="sidebar-link">前后端身份认证</a></li><li class="sidebar-sub-header"><a href="/技术文章/Nodejs/Nodejs.html#其他" class="sidebar-link">其他</a></li></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-6cbeab0a data-v-4698c43e><h3 class="title" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a>Node.js 笔记</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><input type="password" value="" data-v-6cbeab0a> <span data-v-6cbeab0a>Konck! Knock!</span> <button data-v-6cbeab0a>OK</button></label> <div class="footer" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><span data-v-6cbeab0a><i class="iconfont reco-theme" data-v-6cbeab0a></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cbeab0a>vuePress-theme-reco</a></span> <span data-v-6cbeab0a><i class="iconfont reco-copyright" data-v-6cbeab0a></i> <a data-v-6cbeab0a><span data-v-6cbeab0a>Mirror Night</span>
            
          <span data-v-6cbeab0a>2021 - </span>
          2022
        </a></span></div></div> <div data-v-4698c43e><main class="page"><!----> <div class="page-title" style="display:none;"><h1>Node.js 笔记</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>Mirror Night</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2022-09-12 12:00:00</span></i> <!----> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      Javascript
    </span><span class="tag-item" data-v-484a899e>
      Node.js
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><div class="custom-block tip"><p class="custom-block-title">说明</p> <p>Node.js 学习笔记，代码地址：</p> <blockquote><p>https://github.com/MirrorN/Front_Note/tree/master/Node.js</p></blockquote></div> <h2 id="fs-文件读写"><a href="#fs-文件读写" class="header-anchor">#</a> fs 文件读写</h2> <h3 id="readfile-filename-option-callback"><a href="#readfile-filename-option-callback" class="header-anchor">#</a> readFile(filename, [option], callback)</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./text.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> datastr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Read fail. '</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>datastr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>与之类似的函数为 <code>readFileSync(filename, 'utf-8', callback)</code>，表示同步方式读取文件</p> <h3 id="writefile-filename-data-option-callback"><a href="#writefile-filename-data-option-callback" class="header-anchor">#</a> writeFile(filename, data, [option], callback)</h3> <p>写入成功 err 为 null， 写入失败则返回一个错误对象</p> <h3 id="文件路径拼接"><a href="#文件路径拼接" class="header-anchor">#</a> 文件路径拼接</h3> <p>使用node命令会在默认执行位置后拼接相对路径</p> <p>使用  <code>__dirname</code>得到当前文件所在的目录，然后拼接读取文件的位置，以此解决路径错误</p> <h2 id="path-路径模块"><a href="#path-路径模块" class="header-anchor">#</a> path 路径模块</h2> <p>使用 path.join() 拼接路径</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> tmp <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'../b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// b\c ../相当于回到上一级（抵消上一个目录）</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>使用 path.basename() 得到路径中文件名</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>fpath<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'.html'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// 是否移除扩展名</span>

<span class="token keyword">const</span> tmpPath <span class="token operator">=</span> <span class="token string">'./a/c/base.file'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>tmpPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// base.file</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>tmpPath<span class="token punctuation">,</span> <span class="token string">'.file'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//base</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>同样，得到文件的扩展名 ： <code>path.extname(fpath)</code></p> <h2 id="http-模块"><a href="#http-模块" class="header-anchor">#</a> http 模块</h2> <p>http模块是由 node 官方提供的，用于创建 web 服务器的模块，通过调用 http.createServer() 方法，可以将电脑变成web服务器，从而对外发布web服务</p> <p>服务器与普通pc的区别在于，服务器上安装了例如 IIS ，Apache等 web 服务器软件 （phpstudy），node js可以通过 http 模块通过代码手写服务器，测试使用的地址为127.0.0.1，对应的域名为 localhost</p> <p>ip -- 域名（通过DNS进行对应）-- 端口号（每个web服务占用单独一个，80端口号可以省略）</p> <h3 id="创建web服务器"><a href="#创建web服务器" class="header-anchor">#</a> 创建web服务器</h3> <p>创建步骤：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 引入 http 模块</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建 web 服务器实例</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用实例的 .on() 方法 为服务器绑定一个 request 事件</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 如果有来自客户端的请求 就会触发 request 事件</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Someone visit our web server.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 嗲用 listen 方法 启动 web服务器</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http server running at http://127.0.0.1:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="req-请求对象"><a href="#req-请求对象" class="header-anchor">#</a> req 请求对象</h3> <p>服务器接收到客户端的请求后，会调用 server.on() 为服务器绑定 request 事件处理函数，可以通过 req 对象访问客户端相关的数据与属性：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method<span class="token punctuation">;</span>
    <span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">'Your request url is '</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token string">', and req method is '</span><span class="token operator">+</span>req<span class="token punctuation">.</span>method<span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="res响应对象"><a href="#res响应对象" class="header-anchor">#</a> res响应对象</h3> <p>响应对象 res 中包含了服务器相关的数据和属性，使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method<span class="token punctuation">;</span>
    <span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">'Your request url is '</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token string">', and req method is '</span><span class="token operator">+</span>req<span class="token punctuation">.</span>method<span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// res 是响应对象 包含了与服务器相关的数据和属性</span>
    <span class="token comment">// 向客户端发送指定内容 并结束这次请求</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="解决中文乱码问题"><a href="#解决中文乱码问题" class="header-anchor">#</a> 解决中文乱码问题</h3> <p>设置响应头，改变编码格式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>res<span class="token punctuation">.</span><span class="token function">setHeadet</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="根据请求内容返回不同内容"><a href="#根据请求内容返回不同内容" class="header-anchor">#</a> 根据请求内容返回不同内容</h3> <p>根据 url 进行判断：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">'&lt;h1&gt;404 not found &lt;/h1&gt;'</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据 url 判断 设置不同内容</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/'</span> <span class="token operator">||</span> url <span class="token operator">===</span> <span class="token string">'/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        content <span class="token operator">=</span> <span class="token string">'&lt;h1&gt;首页&lt;/h1&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/about.html'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        content <span class="token operator">=</span> <span class="token string">'&lt;h1&gt;关于页面&lt;/h1&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Running at http://127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="模块化"><a href="#模块化" class="header-anchor">#</a> 模块化</h2> <h3 id="模块分类"><a href="#模块分类" class="header-anchor">#</a> 模块分类</h3> <ul><li>内置模块 （fs、http、path等等）</li> <li>自定义模块（自行创建的每个 js 文件）</li> <li>第三方模块（使用前需下载）</li></ul> <h3 id="模块作用域"><a href="#模块作用域" class="header-anchor">#</a> 模块作用域</h3> <p>模块内定义的变量 无法在模块外使用 --- 防止全局作用域污染</p> <h3 id="模块共享"><a href="#模块共享" class="header-anchor">#</a> 模块共享</h3> <p>使用 module 对象，每个模块都有 module 对象，保存的是当前模块的一些属性，使用 module.exports 对象可以向外提供信息， 使用 require 导入模块的时候，所得的结果即是 module.exports 对象</p> <h3 id="exports-对象"><a href="#exports-对象" class="header-anchor">#</a> exports 对象</h3> <p>exports 对象 --- 简化写法的 module.exports 对象（省略 module 前缀）</p> <p><strong>注意，如果页面中同时存在对 exports 和 module.exports 的赋值， 那么结果会以 module.exports 为准</strong>，因此不要再一个文件中同时使用 module.exports  和 exports， 如果使用对象的方式设置 exports 则一定要使用 module.exports:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>module.exports = {
    dateFormat,
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="npm"><a href="#npm" class="header-anchor">#</a> npm</h2> <p>npm：node.js提供的包管理工具</p> <h3 id="moment-使用"><a href="#moment-使用" class="header-anchor">#</a> moment 使用</h3> <ol><li><p>下载对应的包 <code>npm i[nstall] package1 package2</code></p> <ol><li>下载指定版本的包：<code>npm i package@2.22.2</code></li> <li>版本号为三个数字，分别表示  大版本-功能版本-bug修复版本</li> <li>卸载命令为 uninstall</li></ol></li> <li><p>导入 <code>require('moment')</code></p></li> <li><p>使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'moment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Moment&lt;2022-09-15T16:00:48+08:00&gt;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//2022-09-15 16:01:34</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol> <h3 id="创建package-json文件"><a href="#创建package-json文件" class="header-anchor">#</a> 创建package.json文件</h3> <p>在新项目中使用命令：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm init -y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意目录名必须为英文，并且无空格，使用 npm install 安装包的时候，包管理工具会自动将包的信息记录到 package.json 中</p> <p>这样直接使用 <code>npm install</code> 可以直接根据 package.json 文件中的 dependencies 将全部的包都安装完</p> <h3 id="dependencies-和devdependencies"><a href="#dependencies-和devdependencies" class="header-anchor">#</a> dependencies 和devDependencies</h3> <p>仅在开发阶段使用的包记录在 devDependencies 中，使用命令：<code>npm i package -D</code>，可以在 npmjs 网站中查看对应安装命令</p> <h3 id="npm-镜像服务器"><a href="#npm-镜像服务器" class="header-anchor">#</a> npm 镜像服务器</h3> <p>切换国内源：</p> <ol><li><code>npm config get registry</code>：查看当前的镜像源</li> <li><code>npm config set registry=http://....</code></li></ol> <p><strong>借助 nrm 工具切换镜像源：</strong></p> <ol><li><code>npm i nrm -g</code></li> <li><code>nrm ls</code> 查看所有可用源</li> <li><code>nrm use taobao</code></li></ol> <h3 id="i5ting-toc-md文件转h5"><a href="#i5ting-toc-md文件转h5" class="header-anchor">#</a> i5ting_toc md文件转H5</h3> <p><code>npm install -g i5ting_toc</code> 全局安装</p> <p><code>i5ting_toc -f 文件路径 -o</code></p> <h3 id="包的分类"><a href="#包的分类" class="header-anchor">#</a> 包的分类</h3> <ul><li>项目包：项目所用的包</li> <li>全局包： 工具性质的包一般安装为全局，可以通过官方文档查看是否需要全局安装才能使用</li></ul> <h3 id="规范包结构"><a href="#规范包结构" class="header-anchor">#</a> 规范包结构</h3> <p>要求：</p> <ul><li>包必须要以单独目录存在</li> <li>包的顶级目录下必须包含 package.json 文件</li> <li>package.json 中必须包含 name、version、main三个属性</li></ul> <h2 id="模块加载"><a href="#模块加载" class="header-anchor">#</a> 模块加载</h2> <ul><li>优先从缓存中加载</li> <li>优先内置模块</li> <li>自定义模块必须要有 <code>.\</code> <code>..\</code>标识为自定义模块，否则会按照内置模块或第三方模块方式加载</li></ul> <h2 id="express"><a href="#express" class="header-anchor">#</a> Express</h2> <p>基于 node js 的 web 框架（http封装）</p> <p>功能：</p> <ul><li>创建 Web网站服务器 -- 提供网站服务</li> <li>创建 API接口服务器  -- 提供 api 接口</li></ul> <p>例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建server</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 参数1 客户端的请求 url 地址</span>
<span class="token comment">// req：请求对象 -- 请求相关的属性和方法</span>
<span class="token comment">// res：响应对象  -- 响应相关的属性和方法</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 响应一个 JSON 对象</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'zs'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token literal-property property">gender</span><span class="token operator">:</span><span class="token string">'man'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//响应文本</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'query success.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 监听函数</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'express server running at http:127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="获取url中的参数"><a href="#获取url中的参数" class="header-anchor">#</a> 获取url中的参数</h3> <p>使用 <code>req.query</code>对象访问，例如 <code>req.query.name</code></p> <h3 id="获取url中的动态参数"><a href="#获取url中的动态参数" class="header-anchor">#</a> 获取url中的动态参数</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// url中通过 :参数名 动态匹配参数</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:name'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// req.params 默认为空对象</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>输出的结果为 <code>{name: xxxxx}</code></p> <p>如果是 <code>app.get('/:name/:age')</code>，需要匹配两个动态参数</p> <h3 id="托管静态资源"><a href="#托管静态资源" class="header-anchor">#</a> 托管静态资源</h3> <p>通过 express.static() 可以创建一个静态资源服务器，例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>app.use(express.static('public'))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>表示 <strong>public目录下的资源</strong> 对外公开访问，但是这个目录名本身不会出现在 URL 中，例如 public 文件夹下有 images 文件夹，则访问的路径为：<code>localhost:80/images/bg.jpg</code></p> <p>托管多个静态资源目录，可以多次调用 static 函数，如果有重名的资源，则会自上而下查找</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>app.use(express.static('public'))
app.use(express.static('files'))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果想要将静态资源文件夹也加入路径，可以挂在路径前缀：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>app.use('/public', express.static('./public'))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时如果想要加载静态资源，需要加入前缀 'public' <strong>(注意前缀中不要有<code>./</code>)</strong></p> <h3 id="nodemon"><a href="#nodemon" class="header-anchor">#</a> nodemon</h3> <p>使用 nodemon 可以监听项目文件的变动，当代码修改后，nodemon 会自动重启项目，方便调试</p> <p>使用：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>node app.js  -&gt; nodemon app.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h3> <p>express 中，<strong>路由指的是客户端与服务器处理函数之间的映射关系</strong>，路由分为三部分：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>app.METHOD(PATH, HANDLER)

// app.get('/', function(req, res){res.send('xxx')})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>当请求到达服务器后，需要先经过路由的匹配，只有匹配成功之后，才会调用对应的处理函数（请求类型和URL）</p> <h3 id="模块化路由"><a href="#模块化路由" class="header-anchor">#</a> 模块化路由</h3> <p>拆分代码，方便对路由进行模块化管理，将路由抽离为单独的模块，整个过程为：</p> <ol><li>创建路由模块对应文件</li> <li>调用 express.Router()</li> <li>向路由对象挂在具体路由</li> <li>使用 module.exports() 向外共享路由对象</li> <li>使用 app.use() 函数注册路由模块</li></ol> <p>例如，创建模块化路由文件 <code>express-router.js</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'get.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'post.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在 <code>express-router-index.js</code>中导入路由模块：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./express-router'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://127.0.01'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h3> <p>对请求进行预处理：客户端向服务器发送请求 -&gt; 中间件1  -&gt; 中间件2  -&gt; 处理完毕，响应这次请求</p> <p>中间件本质上就是一个 function，格式为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 必须包含 next()方法</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>next()方法将处理转到下一个中间件</p> <h3 id="全局生效的中间件"><a href="#全局生效的中间件" class="header-anchor">#</a> 全局生效的中间件</h3> <p>请求到达服务器之后，总能触发的中间件为全局生效的中间件，使用 <code>app.use()</code>进行注册</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">mv</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>mv<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>多个中间件之间共享同一份 req 和 res， 因此可以在上游的中间件中，统一为 req 和 res 添加自定义属性或方法，供下游的中间件使用，例如，要获得每次 get 或 post 请求到达的时间，可以在全局中间件中获得当前时间，然后将时间赋值添加为 req 的属性</p> <p><strong>请求到达服务器后会根据全局中间件的顺序进行执行</strong></p> <h3 id="局部生效的中间件"><a href="#局部生效的中间件" class="header-anchor">#</a> 局部生效的中间件</h3> <p>局部生效的中间件：只在特定请求中执行，可以在路由中定义：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 在特定get / post 中传入 中间件名称表示只在这个过程中执行</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/a'</span><span class="token punctuation">,</span> mv<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">+</span> <span class="token string">'a page'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>顺序使用多个局部中间件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// []内表示多个中间件 也可以不使用 []</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>mv<span class="token punctuation">,</span> mv2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">+</span> <span class="token string">' main page'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="路由注意事件"><a href="#路由注意事件" class="header-anchor">#</a> 路由注意事件</h3> <ul><li>路由之前定义中间件</li> <li>一定要在<strong>最后</strong>调用 next（）函数</li> <li>连续调用多个中间件的时候，中间件之间共享 req 和 res 对象</li></ul> <h3 id="中间件分类"><a href="#中间件分类" class="header-anchor">#</a> 中间件分类</h3> <ul><li><p>应用级别的中间件：通过 app.use() app.get() 等方式绑定到app实例上的中间件</p></li> <li><p>路由级别的中间件：绑定在 router 实例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'router midware'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>错误级别的中间件，必须要有四个参数（err，req，res，next）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'ERROR!!!'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'main page'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>注意错误级别中间件必须定义在所有路由之后</strong></p></li> <li><p>express 内置中间件</p> <ul><li><p>express.static 托管静态资源 HTML文件 图片 CSS样式等</p></li> <li><p>express.json  解析JSON格式的请求数据 (req.body 可以获得传入的 json 或 url-encoded数据)</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 如果发送的数据为 json 没有定义json解析的话 直接打印 req.body 显示的结果为 undefined</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>express.urlencoded 解析 URL-encoded 格式的请求数据</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>app.use(express.urlencoded({extended: false}))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li> <li><p>第三方中间件 ： 由第三方开发，使用需要安装配置（安装 -&gt; reqiure -&gt; app.use()）</p></li></ul> <h3 id="自定义中间件"><a href="#自定义中间件" class="header-anchor">#</a> 自定义中间件</h3> <p>案例： 定义中间件，完成 post 提交的数据</p> <ol><li>定义中间件</li> <li>监听 req 的 data 事件
<ol><li>如果数据量较大 无法一次性发送，客户端会将数据集逆行切割，分批发送到服务器，因此 data 事件可能会触发多次，每次获得一部分数据，需要最后手动对数据进行拼接</li></ol></li> <li>监听 req 的 end 事件：标识数据已经全部发送完毕</li> <li>使用 querystring 模块解析请求数据</li> <li>将解析的数据对象挂在为 req.body</li> <li>将自定义中间件封装</li></ol> <h3 id="使用-express-写接口"><a href="#使用-express-写接口" class="header-anchor">#</a> 使用 express 写接口</h3> <p>get / post 挂载 router</p> <h3 id="cors跨域资源分享"><a href="#cors跨域资源分享" class="header-anchor">#</a> CORS跨域资源分享</h3> <p>接口跨域问题的解决方法：</p> <ul><li>CORS： 推荐使用方法</li> <li>JSONP：有缺陷，只支持 GET 请求</li></ul> <p>使用 cors 中间件解决跨域问题：</p> <ol><li><code>npm install cors</code> 安装中间件</li> <li><code>const cors = require('cors')</code>导入中间件</li> <li>在路由前调用 <code>app.use(cors())</code> 配置中间件</li></ol> <p>CORS（Cross-Origin Resource Sharing）由一系列 HTTP 响应头组成，这些响应头决定了浏览器是否阻止前端JS代码跨域获取资源 --》 <strong>浏览器的同源安全策略默认情况下会阻止网页跨域获取资源</strong>，但是如果接口服务器配置了CORS相关的HTTP响应头，就可以解除浏览器端的跨域访问限制</p> <p>CORS的主要特点：</p> <ul><li>CORS在服务器端进行配置，客户端浏览器无需处理</li> <li>存在兼容性问题（Chrome4+, FireFox3.5+)</li></ul> <h3 id="cors响应头部设置"><a href="#cors响应头部设置" class="header-anchor">#</a> CORS响应头部设置</h3> <h4 id="access-control-allow-origin"><a href="#access-control-allow-origin" class="header-anchor">#</a> Access-Control-Allow-Origin</h4> <p>用于设置允许访问该资源的外域URL， 例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>res.setHeader('Access-Control-Allow-Origin', 'http://xxxx')
// 表示只允许访问 http://xxxx开头的请求

res.setHeader('Access-Control-Allow-Origin', '*')
// *为通配符 表示允许来自任何域的请求
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="access-control-allow-headers"><a href="#access-control-allow-headers" class="header-anchor">#</a> Access-Control-Allow-Headers</h4> <p>请求头设置，默认设置下CORS支持客户端向服务器发送9个请求头：</p> <p>Accept, Accept-Language, Content-Language, DPR, Downlink, Save-Data, Viewport-Width, Width, Content-Type</p> <p>如果想要从客户端向服务器发送额外的请求头信息，需要在服务器中对额外的请求头进行声明：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>res.setHeader('Access-Control-Allow-Headers', 'Content-Type, X-Custom-Header')
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="access-controls-allow-methods"><a href="#access-controls-allow-methods" class="header-anchor">#</a> Access-Controls-Allow-Methods</h4> <p>设置允许的请求类型</p> <p>默认情况下，CORS仅支持 GET、POST和HEAD请求</p> <p>如果希望通过 PUT，DELETE 等方式请求资源，需要设置实际其ing求允许的HTTP方法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>res.setHeader('Access-Controls-Allow-Methods', 'GET, POST, PUT, HEAD, DELETE')

// 同样使用 * 表示允许全部的方式
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="cors请求的分类"><a href="#cors请求的分类" class="header-anchor">#</a> CORS请求的分类</h3> <ul><li>简单请求：
<ul><li>请求方式为 GET POST HEAD 之一</li> <li>http头部为默认的9个请求头，无自定义头部</li></ul></li> <li>预检请求
<ul><li>请求方式为 GET， POST， HEAD之外的类型</li> <li>请求头中包含自定义的头部</li> <li>向服务器发送了 application/json格式的数据</li> <li>其特点为：浏览器与服务器及逆行正式通信之前，浏览器会先发送 OPTION 请求进行预检，服务器响应预检请求之后，才会发送真正的请求，并且携带真实数据</li></ul></li></ul> <h2 id="数据库与身份认证"><a href="#数据库与身份认证" class="header-anchor">#</a> 数据库与身份认证</h2> <h3 id="关系型数据库和非关系型数据库"><a href="#关系型数据库和非关系型数据库" class="header-anchor">#</a> 关系型数据库和非关系型数据库</h3> <p>关系型数据库，例如 MySql、Sql Server以及Oracle等</p> <p>非关系型数据库， NoSQL（Not Only SQL），表示对传统关系型数据库的扩充，主要是针对当前网页数据量增大的情况做出的改进，特点为：</p> <ul><li>对于数据量非常大的时候，使用关系型数据库效率较低，使用NoSql可以提高访问效率</li> <li>易于拓展</li> <li>数据结构灵活</li></ul> <p>非关系型数据库的分类有键值存储数据库（Redis），列存储数据库（HBase），文档存储数据库（MongoDB）以及图数据库等</p> <h3 id="创建数据库"><a href="#创建数据库" class="header-anchor">#</a> 创建数据库</h3> <p>使用 MySql WorkBench 操作数据库，注意其数据类型以及一些字段的特殊标识：</p> <ul><li>TINYINT(1) 布尔值</li> <li>PK（Primary Key）： 主键</li> <li>NN（Not Null）：值非空</li> <li>UQ（Unique）：值唯一</li> <li>AI（Auto Increment）：自动增长</li></ul> <h3 id="数据库基本操作"><a href="#数据库基本操作" class="header-anchor">#</a> 数据库基本操作</h3> <p>查询：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- select * from table</span>
<span class="token keyword">select</span> username<span class="token punctuation">,</span> password <span class="token keyword">from</span> users
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>插入数据：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'ZhaoLiu'</span><span class="token punctuation">,</span> <span class="token string">'zl'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>更改数据：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">update</span> users <span class="token keyword">set</span> password<span class="token operator">=</span><span class="token string">'11111'</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">3</span>
<span class="token comment">-- 更改多列数据</span>
<span class="token keyword">update</span> users <span class="token keyword">set</span> password<span class="token operator">=</span><span class="token string">'33333'</span><span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>删除数据：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 注意一定要加删除的条件 否则容易删除整张表</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="where语句"><a href="#where语句" class="header-anchor">#</a> where语句</h3> <p>限定查询、修改等操作的条件，其运算符包括等于、不等于、大于小于等等，注意几个较为特殊的运算符：</p> <ul><li><code>&lt;&gt;</code>或者<code>!=</code>都可以用于表示不等于</li> <li>注意SQL中等于的比较是<code>=</code></li> <li><code>between</code>用于限定某个范围</li> <li><code>like</code>搜索某种模式，用于模糊匹配</li></ul> <h3 id="and-和-or"><a href="#and-和-or" class="header-anchor">#</a> and 和 or</h3> <p>分别表示条件同时满足和只满足任意一个条件即可</p> <h3 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h3> <p>使用 order by 可以对查询结果进行<strong>升序排序</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">asc</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中 <code>asc</code> 表示升序，可以省略不写，如需要降序排序，可以使用 <code>desc</code></p> <p><strong>多重排序</strong>：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">status</span> <span class="token keyword">desc</span><span class="token punctuation">,</span> username <span class="token keyword">asc</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用<code>,</code>分隔多个排序关键字</p> <h3 id="count-和-as"><a href="#count-和-as" class="header-anchor">#</a> count  和 as</h3> <p>使用 count 关键字统计数据条数</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用 as 设置别名，例如为count的结果设置别名：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total <span class="token keyword">from</span> users <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可以使用 as 为普通查询结果设置别名：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> username <span class="token keyword">as</span> uanme <span class="token keyword">from</span> users
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="node-js-操作-mysql"><a href="#node-js-操作-mysql" class="header-anchor">#</a> Node.js 操作 MySql</h2> <h3 id="基本步骤"><a href="#基本步骤" class="header-anchor">#</a> 基本步骤</h3> <ol><li>安装操作 MySql 数据库的第三方模块 （MySql）</li> <li>通过 MySql 模块连接到数据库</li> <li>通过 MySql 模块执行 Sql 语句</li></ol> <p>安装 MySql 模块：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm i mysql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="连接数据库与配置"><a href="#连接数据库与配置" class="header-anchor">#</a> 连接数据库与配置</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">// 测试 MySql 的连接</span>
const e <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'cors'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const mysql <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 建立 MySql 数据库连接并配置</span>
const db <span class="token operator">=</span> mysql<span class="token punctuation">.</span>createPool<span class="token punctuation">(</span>{
    host: <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    <span class="token keyword">user</span>: <span class="token string">'root'</span><span class="token punctuation">,</span>
    password: <span class="token string">'admin123'</span><span class="token punctuation">,</span>
    <span class="token keyword">database</span>: <span class="token string">'my_dv_01'</span><span class="token punctuation">,</span>
}<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 检测数据库是否正常工作</span>
db<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">'SELECT 1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span>{
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>{
        <span class="token keyword">return</span> console<span class="token punctuation">.</span>log<span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    }
    console<span class="token punctuation">.</span>log<span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
}<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="sql语句执行"><a href="#sql语句执行" class="header-anchor">#</a> sql语句执行</h3> <h4 id="查询语句"><a href="#查询语句" class="header-anchor">#</a> 查询语句</h4> <p>select 查询语句返回的是一个数组</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> sqlStr <span class="token operator">=</span> <span class="token string">'select * from users'</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="插入语句"><a href="#插入语句" class="header-anchor">#</a> 插入语句</h4> <p>插入语句：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'Qian'</span><span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'qian'</span><span class="token punctuation">,</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 通过占位符方式将实际数据传入</span>
<span class="token keyword">const</span> sqlStr <span class="token operator">=</span> <span class="token string">'insert into users (username, password, status) values (?, ?, ?)'</span><span class="token punctuation">;</span>

db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> <span class="token punctuation">[</span>user<span class="token punctuation">.</span>username<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>status<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断语句执行结果是否正确 如果实际影响到的行数为1则执行成功</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Insert Done.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>如果待插入的数据对象的每个属性与数据表的字段一一对应，则可以使用简化的插入语句：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'Sun'</span><span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'sun'</span><span class="token punctuation">,</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// ? 表示占位符</span>
<span class="token keyword">const</span> sqlStr <span class="token operator">=</span> <span class="token string">'insert into users set ?'</span><span class="token punctuation">;</span>

<span class="token comment">// 直接将数据对象当作占位符的值</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Insert Done.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="更新语句"><a href="#更新语句" class="header-anchor">#</a> 更新语句</h4> <p>使用普通方法逐属性更新：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'Qi'</span><span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'iiii'</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 使用占位符代替数据</span>
<span class="token keyword">const</span> sqlStr <span class="token operator">=</span> <span class="token string">'update users set password=?, username=? where id=?'</span><span class="token punctuation">;</span>

db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> <span class="token punctuation">[</span>user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>username<span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Update Done.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>简化写法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token literal-property property">username</span><span class="token operator">:</span><span class="token string">'QIAN'</span><span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'qqqq'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sqlStr <span class="token operator">=</span> <span class="token string">'update users set ? where id=?'</span><span class="token punctuation">;</span>

db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> <span class="token punctuation">[</span>user<span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'update done.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="删除语句"><a href="#删除语句" class="header-anchor">#</a> 删除语句</h4> <p>删除的时候一般都会根据 <code>id</code> 进行删除（<code>id</code>都具有唯一性）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> sqlStr <span class="token operator">=</span> <span class="token string">'delete from users where id=?'</span><span class="token punctuation">;</span>

db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Delete done'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>实际场景</strong>： 实际情况下，由于用户存在误删等操作，因此为了保险起见，<strong>更推荐使用标记删除的方式</strong>，即在数据表中设置 status 这样的状态字段，用于标记当前数据是否被删除，当用户执行了删除操作时，这样用户执行删除的动作时，实际上执行的是 update 语句</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> sqlStr <span class="token operator">=</span> <span class="token string">'update users set status=1 where id=?'</span><span class="token punctuation">;</span>

db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Delete done.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="数据库操作"><a href="#数据库操作" class="header-anchor">#</a> 数据库操作</h3> <h4 id="关于返回数据格式"><a href="#关于返回数据格式" class="header-anchor">#</a> 关于返回数据格式</h4> <p>使用 select 返回的数据格式为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>res = [
  RowDataPacket { month: 'Apr', grade: 45 },
  RowDataPacket { month: 'Aug', grade: 68 },
  RowDataPacket { month: 'Dec', grade: 88 },
 ]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>但是实际使用的时候，可以忽略中间的 RowDataPacket这一层，直接使用即可：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>res[i].month   /   res[i].grade
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果想要对象数组的格式，可以使用JSON处理：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>let tmpRes = JSON.parse(JSON.stringify(results));
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>let obj = {};
obj[results[i].month] = results[i].grade;
res.push(obj);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>对于转化为 JSON对象数组形式的数据，现有需求：将每个JSON对象第一个值抽出为一个数组，将第二个值也抽出为一个单独数组，例如：<code>{'month': '2011-01', num: 12}</code> 得到 <code>[2011-01], [12]</code>两个数组</p> <p>做法如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> jsonStr <span class="token operator">=</span> <span class="token string">'[{&quot;name&quot;: &quot;zs&quot;, &quot;age&quot;: 12}, {&quot;name&quot;: &quot;lis&quot;, &quot;age&quot;: 15}]'</span>
<span class="token keyword">const</span> objArr <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objArr<span class="token punctuation">)</span>  <span class="token comment">// [['zs', 12], ['lis', 15]]</span>
<span class="token keyword">const</span> valList1 <span class="token operator">=</span> objArr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// ['zs', 'lis']</span>
<span class="token keyword">const</span> valList2 <span class="token operator">=</span> objArr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>思路：</strong>  首先得到 JSON 对象数组，利用 map 遍历所有的对象，并获得所有的值，此时获得的结果是一个二维数组，随后利用 map 对每个数组进行遍历取值，分别存入两个数组中即可</p> <h2 id="异步"><a href="#异步" class="header-anchor">#</a> 异步</h2> <h3 id="回调函数"><a href="#回调函数" class="header-anchor">#</a> 回调函数</h3> <p>Node.js 异步编程的最直接体现就是回调函数，函数完成任务后会调用回调函数，例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">function</span> <span class="token function">funcPrint</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">6</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>        
    <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token function">timer</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> funcPrint<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>几个概念：</p> <ul><li>同步：程序自上而下依次执行   ----   阻塞，只能顺序执行，如果中间某个地方耗时长，后续代码也无法执行</li> <li>异步：可以同时执行多个操作  ----- 非阻塞，如果中间有操作耗时较长，后续代码会继续执行</li></ul> <p><strong>回调函数</strong>：回调函数作为参数传递给另一个函数，并且会在另一个函数完成后立即执行，这个回调函数会在传给的函数内部执行</p> <h3 id="事件循环"><a href="#事件循环" class="header-anchor">#</a> 事件循环</h3> <p>Node.js 是单进程单线程应用程序，其通过事件和回调支持并发，Node.js 单线程类似进入一个 <code>while(true)</code>的事件循环，直到没有事件观察者，每个异步事件都生成一个事件观察者，如果有事件发生就调用该回调函数</p> <p>回调地狱：多次回调函数嵌套</p> <p>解决回调地狱的方案：</p> <ul><li>使用 Promise</li> <li>使用 async-await</li> <li>使用 async.js 库</li></ul> <h3 id="promise-对象"><a href="#promise-对象" class="header-anchor">#</a> Promise 对象</h3> <p>Promise构造函数示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> pomis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>操作成功<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">rejct</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Promise 构造参数接收一个函数作为参数，该函数有两个参数，分别为 resolve 和 reject，其作用为：</p> <ul><li>resolve： 将 promise 对象由  pending 状态转变为 fufilled 状态 （成功），<strong>其作用为异步操作成功时调用，并将结果传递出去</strong>（可以想象为改函数替你保存异步操作的结果，因此最后要 resolve(res)）</li> <li>reject：将 promise 对象由 pending 状态转变为 rejected 状态（失败），<strong>其作用为将异步操作失败所报的错误作为参数传递出去</strong></li></ul> <p>Promise 实例生成以后可以使用 then 方法指定 resolve 和 rejected 状态的回调函数（可选），并且他们<strong>都接收promise对象传出的值作为参数</strong>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 状态转变为 resolve 时调用</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 装填转变为 rejected 时调用</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>因此，对于promise构造函数中的 resolve 和 reject 函数，分别用于传递实际操作结果和错误，并且结果作为参数传递到 then 函数中，例如数据库的操作：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 如果数据库操作出现错误 将错误通过 reject 函数传递出去</span>
            <span class="token comment">// 相当于什么也不做 只是做了个转发 resolve(err){return err}</span>
            <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 成功执行的结果通过 resolve 函数传递出去</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 接收 resolve 函数的返回结果 res = resolve()</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 接收 reject 的返回的结果</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>一般来说，调用 resolve 或者 reject 函数之后， promise 对象的操作就结束了，之后的处理应该在 then 中进行，所以 resolve 和 reject 函数后面不应该有代码，因此最好在两个函数前面加上 return 语句，这样就不会有意外：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
	success<span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fail<span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="then-方法-promise-prototype-then"><a href="#then-方法-promise-prototype-then" class="header-anchor">#</a> then 方法 (Promise.prototype.then())</h4> <p>Promise 实例具有 then 方法，其作用是为 promise 实例添加状态改变时候的回调函数，可以传入两个函数作为 resolved 和 rejected 状态的回调函数，then 函数也可以写为链式形式，指定一组按次序调用的回调函数，即：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>function().then(){
	// ...
}.then(){
	// ..
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其中前一个回调函数也可以是一个 promise 对象，此时后一个 then 方法会等待前一个 promise 对象变为 resolved 或者 rejected 状态才会调用</p> <h4 id="catch-方法-promise-prototype-catch"><a href="#catch-方法-promise-prototype-catch" class="header-anchor">#</a> catch 方法 （Promise.prototype.catch()）</h4> <p>用于指定错误的回调函数，<code>then</code> 方法参数中的第二个函数表示 rejected 状态时的操作，这一函数也可以单独写出成为 <code>catch</code> 方法，即用来捕获异步操作过程中的错误，此外如果 <code>then</code> 方法指定的回调函数如果出现错误，也会被 <code>catch</code> 方法捕获。此外，<strong>更推荐使用 <code>catch</code> 方法捕获错误，而不是再 <code>then</code> 方法中定义 rejected 状态的回调函数</strong>，例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getBooksAjax</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> ind <span class="token operator">=</span> <span class="token number">1</span>
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">+</span><span class="token string">'?id='</span><span class="token operator">+</span>ind<span class="token punctuation">)</span>
        xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 推荐写成 return 的方式</span>
                <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> promise
<span class="token punctuation">}</span>

<span class="token function">getBooksAjax</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 推荐使用 catch 捕获rejected的返回结果</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="finally方法-promise-prototype-finally"><a href="#finally方法-promise-prototype-finally" class="header-anchor">#</a> finally方法（Promise.prototype.finally()）</h4> <p>finally 方法不管 promise 最终是哪种状态都会执行，finally 中的操作与 promise 的状态并无关系，并且该方法的回调函数不接受参数，例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">getBooksAjax</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'done.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="promise-all-方法"><a href="#promise-all-方法" class="header-anchor">#</a> Promise.all()方法</h4> <p>Promise.all()方法用于将多个 promise 实例包装成一个新的 promise 实例，最终新的 promise 对象的状态由所有的 promise 实例决定：</p> <ul><li>p1,p2,...pn 所有的状态全部为 fulfilled ，最终状态才变为 fulfilled</li> <li>p1,p2,...pn 有一个状态变为 rejected，最终状态就i会变为 rejected</li></ul> <p>例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getBooks2</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="async-和-await"><a href="#async-和-await" class="header-anchor">#</a> async 和 await</h3> <p><code>async</code> 声明 function 是一个异步函数，返回一个 promise 对象，使用与 promise 语法类似，可以使用 then 方法添加回调函数，其中 <code>async</code> 函数内部返回的值，会成为 then 方法回调函数的参数</p> <p><code>await</code> 操作符只能在异步函数 async function 内部使用，如果一个 Promise 被传递给一个 await 操作符，await 将等待 promise 正常处理完成并返回其处理结果，也就是会阻塞后面的代码，如果等待的不是 promise 对象，则会返回该值本身</p> <p>方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">printBooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">getBooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">+</span><span class="token string">'?id=1'</span><span class="token punctuation">)</span>
        xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusText<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">getBooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">printBooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>此时，由于请求信息的函数进入 event table， <code>console.log('done')</code> 会先执行，所以输出的结果是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>done
{book info}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用 async - await 后：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="前后端身份认证"><a href="#前后端身份认证" class="header-anchor">#</a> 前后端身份认证</h2> <h3 id="web-开发模式"><a href="#web-开发模式" class="header-anchor">#</a> Web 开发模式</h3> <p>web开发模式的分类：</p> <ul><li>基于服务器渲染的传统 web 开发模式</li> <li>基于前后端分离的新型 web 开发模式</li></ul> <h4 id="服务器端渲染的-web-开发模式"><a href="#服务器端渲染的-web-开发模式" class="header-anchor">#</a> 服务器端渲染的 web 开发模式</h4> <p>服务器端渲染的概念：服务器发送给客户端的 HTML 页面，是服务器通过字符串拼接方式动态生成的，客户端不需要使用   Ajax 这样的技术额外请求页面的数据</p> <p>优点：</p> <ul><li>前端耗时少</li> <li>有利于 SEO， 服务器返回的是完整的页面，所以爬虫更容易获得信息，更易被搜索发现</li></ul> <p>缺点：</p> <ul><li>占用服务器资源：服务器需要控制HTML页面的生成</li> <li>不利于前后端分离，开发效率低</li></ul> <h4 id="前后端分离的-web-开发模式"><a href="#前后端分离的-web-开发模式" class="header-anchor">#</a> 前后端分离的 web 开发模式</h4> <p>后端只负责提供 API 接口，前端使用 Ajax 调用接口</p> <p>优点：</p> <ul><li>开发体验好：前端只负责页面开发，后端专注于 api 开发</li> <li>Ajax 可以实现局部页面的刷新，用户体验好</li> <li>减轻了服务器端的渲染压力</li></ul> <p>缺点：</p> <ul><li>不利于 SEO 完整页面是在客户端动态生成的，所以爬虫无法获取有效信息（使用VUE，React等框架的 SSR（server side render）可以解决这一问题）</li></ul> <h4 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h4> <ul><li>主要功能是展示，没有复杂交互的项目（例如企业级网站），适合使用服务器渲染方式</li> <li>交互性比较强，不需要考虑SEO的项目（各种后台管理项目），适合前后端分离的开发模式</li></ul> <p>某些项目也会同时兼顾首页渲染速度和前后端分离开发的效率，采用首屏服务器渲染 + 其他页面前后端分离的开发模式</p> <h4 id="身份认证"><a href="#身份认证" class="header-anchor">#</a> 身份认证</h4> <p>通过一定的手段，对用户身份验证，例如密码登录，邮箱登录或者二维码</p> <ul><li>对于服务器端渲染的方式推荐使用 Session 认证机制</li> <li>前后端分离推荐使用 JWT 认证机制</li></ul> <h4 id="session-认证机制"><a href="#session-认证机制" class="header-anchor">#</a> Session 认证机制</h4> <p>HTTP协议的无状态性：客户端的每次HTTP请求是独立的，连续多个请求之间没有直接的关系，服务器不会主动保留请求的状态
Cookie ： 存储在浏览器中一段不超过 4KB 的字符串，由一个 名称-name，一个值-value和用于控制Cookie有效期、安全性、适用范围的可选属性组成</p> <p>不同域名下的 Cookie 各自独立，每当客户端发起请求的时候，会自动把当前域名下的所有未过期的 Cookie 一同发送到服务器，Cookie特点为：</p> <ul><li>自动发送</li> <li>域名独立</li> <li>过期时限</li> <li>4KB限制</li></ul> <p>客户端第一次请求服务器的时候，服务器会通过响应头的形式将一个身份认证的 Cookie 发送到客户端，客户端会自动将Cookie保存在浏览器中，随后每次请求服务器的时候，浏览器会自动将身份认证相关的 Cookie 通过请求头的形式发送给服务器吗，服务器即可验明客户端身份</p> <p>Cookie不具有安全性： Cookie保存在浏览器中，而且浏览器也提供了读写 Cookie 的 API，因此 Cookie 容易被伪造，因此重要且隐私的数据不要使用 Cookie 存储</p> <p>提高身份认证的安全性：Session认证机制 -- 会员卡 + 刷卡认证</p> <p>Session 的工作原理：</p> <ol><li>浏览器登录，提交账号密码</li> <li>服务器验证账号密码，并保存用户信息，同时生成对应的 Cookie 字符串发送给客户端</li> <li>浏览器保存Cookie</li> <li>浏览器再次请求，发送同域名下的所有 Cookie</li> <li>服务器根据 Cookie 查找对应的用户信息，身份认证成功后发送响应内容</li></ol> <h4 id="express中使用session认证"><a href="#express中使用session认证" class="header-anchor">#</a> express中使用session认证</h4> <p>安装：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm i express-session
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">ssession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// secret属性值可以是任意字符串</span>
    <span class="token literal-property property">secret</span><span class="token operator">:</span> <span class="token string">'anything'</span><span class="token punctuation">,</span>
    <span class="token comment">// 两个属性为固定写法</span>
    <span class="token literal-property property">resave</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">saveUninitializaed</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 登录接口</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/post'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>username <span class="token operator">!==</span> <span class="token string">'admin'</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password <span class="token operator">!==</span> <span class="token string">'0000'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">meg</span><span class="token operator">:</span><span class="token string">'default'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将用户信息 存储到 session 中</span>
req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
<span class="token comment">// 将用户的登陆状态 存储到session中</span>
req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>islogin <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>其中 <code>req.session</code>属性只有在配置session后才会有，可以通过它访问session对象，并向其存储数据，可以通过session对象获取的数据来对登录用户进行判断：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/username'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>islogin<span class="token punctuation">)</span><span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'fail'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span> <span class="token literal-property property">username</span><span class="token operator">:</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以使用 <code>req.session.destroy()</code>  函数清空服务器保存的 session 信息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 退出登录的接口</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/logout'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 清空当前客户端对应的 session 信息</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'login out'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="jwt-认证机制"><a href="#jwt-认证机制" class="header-anchor">#</a> JWT 认证机制</h4> <p>Session 认证的局限性： session 认证需要配合 Cookie 才能实现，由于 Cookie 默认不支持跨域访问，所以涉及到前端跨域请求后端接口的时候需要一些额外的配置，这样才能实现跨域的 Session 认证。</p> <p>因此：</p> <ul><li>不存在跨域请求的时候，推荐使用 session 机制</li> <li>出现跨域请求接口的时候，推荐使用 JWT 认证机制</li></ul> <p>JWT：JSON Web Token 是目前最流行的跨域认证方案</p> <h4 id="jwt-工作流程"><a href="#jwt-工作流程" class="header-anchor">#</a> JWT 工作流程</h4> <ol><li>客户端登录，提交账号和密码</li> <li>服务器验证账号和密码，验证通过之后，服务器会将用户的信息对象，经过加密之后生成 token 字符串并发送给客户端</li> <li>客户端将 token 保存在 localStorage 或 SessionStorage 中</li> <li>客户端再次发起请求的时候，通过请求头的 authorization 字段，将 token 发给服务器</li> <li>服务器还原token字符串并检查用户身份，随后根据当前用户生成特定的响应内容并返回响应内容</li></ol> <p>JWT的组成部分：</p> <ul><li>Header</li> <li>Payload： 真正的用户信息，这是用户经过加密后的字符串</li> <li>Signature：Header 和 Signature 是安全性相关额部分， 用于保证 Token 的安全性</li></ul> <h4 id="jwt-使用方式"><a href="#jwt-使用方式" class="header-anchor">#</a> JWT 使用方式</h4> <p>在第一次完成客户端和服务器的通信之后，每次客户端与服务器进行交互，都要带上 token 字符串从而进行身份认证，推荐的做法是把 JWT 字符串放在 HTTP请求头的 Authorization 字符按中：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Authorization: Bearer &lt;token&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="在-express-中使用-jwt"><a href="#在-express-中使用-jwt" class="header-anchor">#</a> 在 express 中使用 JWT</h4> <h5 id="安装依赖包"><a href="#安装依赖包" class="header-anchor">#</a> 安装依赖包</h5> <ul><li>jsonwebtoken：用于生成 JWT 字符串</li> <li>express-jwt：用于将 JWT 字符串解析还原成 JSON 对象</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm i jsonwebtoken express-jwt

const jwt = require('jsonwebtoken');
const expressJWT = require('express-jwt')
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="定义-secret-密钥"><a href="#定义-secret-密钥" class="header-anchor">#</a> 定义 secret 密钥</h5> <p>为了保证 JWT 字符串的安全性，防止 JWT 字符串在网络传输过程中被别人破解，需要专门定义一个用于加密和解密的 secret 密钥，该密钥为字符串，例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>const secretKey = 'abcd NN +_+'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="登录成功后生成-jwt-字符串"><a href="#登录成功后生成-jwt-字符串" class="header-anchor">#</a> 登录成功后生成 JWT 字符串</h5> <p>使用 <code>jsonwebtoken.sign()</code>方法可以将用户信息加密成 JWT 字符串</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> tokenStr <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">username</span><span class="token operator">:</span> userInfo<span class="token punctuation">.</span>username<span class="token punctuation">}</span><span class="token punctuation">,</span> secretKey<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">expiresIn</span><span class="token operator">:</span> <span class="token string">'30s'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'login success'</span><span class="token punctuation">,</span>
        <span class="token comment">// 调用 sign() 方法生成 JWT 字符串 参数分别为： 用户信息、加密密钥、配置对象有效期30s, 30h</span>
        <span class="token literal-property property">token</span><span class="token operator">:</span> tokenStr<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h5 id="jwt-字符串还原为-json-对象"><a href="#jwt-字符串还原为-json-对象" class="header-anchor">#</a> JWT 字符串还原为 JSON 对象</h5> <p>通过 <code>jwt({secret: secretKey})</code> 传入密钥，并可以使用 <code>unless()</code> 函数来指定哪些接口不需要访问权限，例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">expressJWT</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">secret</span><span class="token operator">:</span> secretKey<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unless</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/api\\</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里 <code>unless()</code> 函数通过正则表达式指定 <code>/api</code> 下的接口都不需要访问权限</p> <h5 id="使用-req-user-查看用户信息"><a href="#使用-req-user-查看用户信息" class="header-anchor">#</a> 使用 <code>req.user</code> 查看用户信息</h5> <p>配置成功 expressJWT 后，会自动向 <code>req</code> 对象中挂载一个 <code>.user</code> ，其中包含了对象的信息（注意这里的对象信息是之前通过 <code>sign()</code>方法添加的）</p> <h5 id="捕获解析-jwt-失败之后产生的错误"><a href="#捕获解析-jwt-失败之后产生的错误" class="header-anchor">#</a> 捕获解析 JWT 失败之后产生的错误</h5> <p>使用 express-jwt 解析 token 字符串的时候，如果字符串发送的 token 字符串过期或者不合法，会产生一个解析失败的错误，影响项目的正常运行，可以通过 express 的错误中间价捕获这个错误并进行处理：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 解析失败导致的错误</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'UnauthorizedError'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'无效的token'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 其他原因导致的错误</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> messageL <span class="token string">'未知错误'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h2> <h3 id="package-json-和-package-lock-json"><a href="#package-json-和-package-lock-json" class="header-anchor">#</a> package.json 和 package-lock.json</h3> <p><code>npm init -y</code>初始化项目后会生成 <code>package.json</code> 文件用于保存安装模块的信息。这样在拉取项目的时候可以根据保存的信息安装项目的相关依赖，但问题在于 <strong><code>package.json</code>只能锁定大版本，即只负责大版本一致的情况下，安装最新的小版本</strong>，这样并不利于项目的稳定性，因此出现了 <code>package-lock.json</code> 文件用于保存依赖包的版本号、下载地址以及子依赖包等信息，并且<strong>可以锁定小版本号</strong>，从而保证在新拉取项目的时候也可以与之前保持一致。</p> <p>这样，当执行 npm install 命令的时候，首先从 <code>package.json</code>中获取模块名称，随后在 <code>package-lock.json</code> 中获取版本号，随后进行下载更新。</p> <h3 id="linux-安装-mysql注意点"><a href="#linux-安装-mysql注意点" class="header-anchor">#</a> Linux 安装 mysql注意点</h3> <ol><li><p>注意版本一致，使用命令 <code>cat /etc/redhat-release</code>查看版本</p></li> <li><p>安装mysql依赖包的时候出现依赖错误：</p> <div class="language-linux line-numbers-mode"><pre class="language-text"><code>error: Failed dependencies: mariadb-libs is obsoleted by mysql-community-libs-8.0.28-1.el7.x86_64
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>解决方法为：先卸载 mysql-libs ，再执行安装：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yum remove mysql-libs
rpm .....
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>安装 mysql 服务器时失败：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>error: Failed dependencies:mysql-community-icu-data-files = 8.0.28-1.el7 is needed by mysql community-server-8.0.28-1.el7.x86_64
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>解决方法为:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>rpm -ivh mysql-community-server-8.0.28-1.el7.x86_64.rpm --force --nodeps
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装的时候忽略依赖关系</p></li> <li><p>启动服务器之后，查看安装  mysql 生成的临时密码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cat /var/log/mysqld.log
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <p>参考：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>https://blog.csdn.net/xhmico/article/details/125197747
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----></main> <!----> <div class="comments-wrapper" data-v-4698c43e><!----></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div><!----><!----><!----></div></div>
    <script src="/assets/js/app.d527f978.js" defer></script><script src="/assets/js/4.59a1108c.js" defer></script><script src="/assets/js/1.2bab5923.js" defer></script><script src="/assets/js/32.c7f6cae2.js" defer></script><script src="/assets/js/12.216bf9d4.js" defer></script>
  </body>
</html>
